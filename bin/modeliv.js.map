{"version":3,"sources":["modeliv.entry.ts"],"names":[],"mappings":"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","file":"modeliv.js","sourcesContent":["declare class Proxy {\r\n    constructor(object: Object, handler: Object);\r\n}\r\n\r\nconst _states = [] as Function[];\r\ninterface IInstance {\r\n    tier: any;\r\n    version?: number;\r\n};\r\n\r\nlet _instances = [] as { name: string, instance: any }[];\r\n\r\nexport interface Message {\r\n    tier: any;\r\n    name: string;\r\n    value: any;\r\n    store?: any;\r\n}\r\n\r\nlet messages = [] as Message[];\r\n\r\nfunction construct(constructor: Function, args: any[]) {\r\n    args = [null].concat(args);\r\n    const factoryFunction = constructor.bind.apply(constructor, args);\r\n    return new factoryFunction();\r\n}\r\n\r\nexport function state(constructor: Function) {\r\n    const name = (constructor as any).name;\r\n    console.log(\"state: \" + name);\r\n    _states.push(constructor);\r\n\r\n    var new_constructor = ((...args: any[]) => {\r\n        const instance = construct(constructor, args);\r\n        console.log(\"instance: \" + instance.constructor.name);\r\n        _instances.push({ name, instance });\r\n\r\n        return new Proxy({}, {\r\n            get(target: Object, name: string) {\r\n                if (name === \"dispose\")\r\n                    return () => {\r\n                        console.log(\"dispose: \" + instance.constructor.name);\r\n                        var l = _instances.length;\r\n                        _instances = _instances.filter(i => i.instance !== instance);\r\n                        if (_instances.length - l == 0)\r\n                            console.log(\"disposed 0 from \" + JSON.stringify(_instances));\r\n\r\n                        console.log(\"disposed \" + (l - _instances.length));\r\n\r\n                        if (instance.dispose)\r\n                            instance.dispose();\r\n                    };\r\n                console.log(\"getting \" + name + \" from \" + JSON.stringify(instance));\r\n                return instance[name];\r\n            }\r\n        });\r\n    });\r\n    new_constructor.prototype = constructor.prototype;\r\n    return new_constructor as any as void;\r\n}\r\n\r\nexport function dispatch(tier: any, actionName: string, args: any[], propogate = true) {\r\n    console.log(\"dispatch: \" + actionName + \"(\" + JSON.stringify(args).slice(1, -1) + \")\");\r\n\r\n    if (propogate)\r\n        queue(\"action\", { tier, name: actionName, value: args });\r\n\r\n    const instances = _instances.filter(i => i.instance.tier === tier);\r\n    console.log(\"looking for instance of action. \" + instances.length + \" total instances of actions\");\r\n    for (const instance_info of instances.filter(i => typeof i.instance[actionName] === \"function\")) {\r\n        var instance = instance_info.instance;\r\n        dispatchTo(instance, tier, instance_info.name, instance[actionName] as Function, args);\r\n    }\r\n}\r\n\r\nfunction withoutTier(o: Object) {\r\n    const value = JSON.parse(JSON.stringify(o));\r\n    delete value.tier;\r\n    return value;\r\n}\r\n\r\nfunction dispatchTo(instance: IInstance, from_tier: any, name: string, fn: Function, args: any[]) {\r\n    console.log(\"=> \" + name);\r\n    const old = JSON.stringify(withoutTier(instance));\r\n\r\n    fn.apply(instance, args);\r\n\r\n    const value = withoutTier(instance);\r\n\r\n    if (old !== JSON.stringify(value)) {\r\n        let version = instance.version;\r\n        console.log(\"new version from \" + version);\r\n        instance.version = (version || 0) + 1;\r\n        value.version = instance.version;\r\n        console.log(\"to \" + instance.version);\r\n        queue(\"change\", { tier: from_tier, store: name, name: \"setAll\", value });\r\n\r\n        console.log(\"message: \" + JSON.stringify(messages[messages.length - 1]));\r\n    }\r\n}\r\n\r\nfunction queue(reason: string, message: any) {\r\n    console.log(\"queueing message because \" + reason + \": \" + JSON.stringify(message));\r\n    messages.push(message);\r\n}\r\n\r\nexport function messagesFor(sv: any[][]) {\r\n    messages.splice(0, messages.length);\r\n\r\n    for (const instance_info of _instances)\r\n        if (sv.filter(v => v[0] === instance_info.name && v[1] >= (instance_info.instance.version || 0)).length)\r\n            queue(\"change (initial)\", { tier: instance_info.instance.tier, store: instance_info.name, name: \"setAll\", value: instance_info.instance });\r\n}\r\n\r\nexport function getStoreVersions() {\r\n    return _instances.map(instance => ({\r\n        name: instance.name,\r\n        version: instance.instance.version || 0\r\n    }));\r\n}\r\n\r\nexport function ActionsAt(tier: any): any {\r\n    return new Proxy({}, {\r\n        get(target: Object, name: string) {\r\n            if (name === \"toJSON\")\r\n                return () =>\r\n                    \"[Proxy]\";\r\n            if (name === \"inspect\")\r\n                return () =>\r\n                    \"[Proxyinspect]\";\r\n\r\n            return (...args: any[]) =>\r\n                dispatch(tier, name, args);\r\n        }\r\n    });\r\n}\r\n\r\nexport function getMessagesToSend(tier: any = null) {\r\n    console.log(\"getMessagesFrom: \" + tier + \" have \" + messages.length + \" queued messages\");\r\n    const result = messages.filter(m => tier == null || m.tier === tier);\r\n    messages = messages.filter(m => tier != null && m.tier !== tier);\r\n    return result.length ? result : null;\r\n}\r\n\r\nexport function gotMessages(tier: any, messages: Message[]) {\r\n    console.log(\"gotMessages at tier \" + tier + \": \" + messages.length + \" messages\");\r\n    for (var m of messages)\r\n        if (m.name === \"setAll\" && m.store) {\r\n            const stores = _instances.filter(i => i.name === m.store && i.instance.tier === tier);\r\n            for (var key in m.value)\r\n                if (m.value.hasOwnProperty(key))\r\n                    for (const store of stores)\r\n                        store.instance[key] = m.value[key];\r\n\r\n        } else\r\n            dispatch(tier, m.name, m.value, false);\r\n}\r\n\r\nexport class TieredState<T> {\r\n    constructor(public tier: T) { }\r\n}"],"sourceRoot":"."}