"use strict";function construct(e,n){n=[null].concat(n);var t=e.bind.apply(e,n);return new t}function state(e){var n=e.name;console.log("state: "+n),_states.push(e);var t=function(){for(var t=[],s=0;s<arguments.length;s++)t[s-0]=arguments[s];var o=construct(e,t);return console.log("instance: "+o.constructor.name),_instances.push({name:n,instance:o}),new Proxy({},{get:function(e,n){return"dispose"===n?function(){console.log("dispose: "+o.constructor.name);var e=_instances.length;_instances=_instances.filter(function(e){return e.instance!==o}),_instances.length-e==0&&console.log("disposed 0 from "+JSON.stringify(_instances)),console.log("disposed "+(e-_instances.length)),o.dispose&&o.dispose()}:(console.log("getting "+n+" from "+JSON.stringify(o)),o[n])}})};return t.prototype=e.prototype,t}function dispatch(e,n,t,s){void 0===s&&(s=!0),console.log("dispatch: "+n+"("+JSON.stringify(t).slice(1,-1)+")"),s&&queue("action",{tier:e,name:n,value:t});var o=_instances.filter(function(n){return n.instance.tier===e});console.log("looking for instance of action. "+o.length+" total instances of actions");for(var r=0,i=o.filter(function(e){return"function"==typeof e.instance[n]});r<i.length;r++){var a=i[r],c=a.instance;dispatchTo(c,e,a.name,c[n],t)}}function withoutTier(e){var n=JSON.parse(JSON.stringify(e));return delete n.tier,n}function dispatchTo(e,n,t,s,o){console.log("=> "+t);var r=JSON.stringify(withoutTier(e));s.apply(e,o);var i=withoutTier(e);if(r!==JSON.stringify(i)){var a=e.version;console.log("new version from "+a),e.version=(a||0)+1,i.version=e.version,console.log("to "+e.version),queue("change",{tier:n,store:t,name:"setAll",value:i}),console.log("message: "+JSON.stringify(messages[messages.length-1]))}}function queue(e,n){console.log("queueing message because "+e+": "+JSON.stringify(n)),messages.push(n)}function messagesFor(e){messages.splice(0,messages.length);for(var n=function(n){e.filter(function(e){return e[0]===n.name&&e[1]>=(n.instance.version||0)}).length&&queue("change (initial)",{tier:n.instance.tier,store:n.name,name:"setAll",value:n.instance})},t=0,s=_instances;t<s.length;t++){var o=s[t];n(o)}}function getStoreVersions(){return _instances.map(function(e){return{name:e.name,version:e.instance.version||0}})}function ActionsAt(e){return new Proxy({},{get:function(n,t){return"toJSON"===t?function(){return"[Proxy]"}:"inspect"===t?function(){return"[Proxyinspect]"}:function(){for(var n=[],s=0;s<arguments.length;s++)n[s-0]=arguments[s];return dispatch(e,t,n)}}})}function getMessagesToSend(e){void 0===e&&(e=null),console.log("getMessagesFrom: "+e+" have "+messages.length+" queued messages");var n=messages.filter(function(n){return null==e||n.tier===e});return messages=messages.filter(function(n){return null!=e&&n.tier!==e}),n.length?n:null}function gotMessages(e,n){console.log("gotMessages at tier "+e+": "+n.length+" messages");for(var t=0,s=n;t<s.length;t++){var o=s[t];if("setAll"===o.name&&o.store){var r=_instances.filter(function(n){return n.name===o.store&&n.instance.tier===e});for(var i in o.value)if(o.value.hasOwnProperty(i))for(var a=0,c=r;a<c.length;a++){var u=c[a];u.instance[i]=o.value[i]}}else dispatch(e,o.name,o.value,!1)}}var _states=[],_instances=[],messages=[];exports.state=state,exports.dispatch=dispatch,exports.messagesFor=messagesFor,exports.getStoreVersions=getStoreVersions,exports.ActionsAt=ActionsAt,exports.getMessagesToSend=getMessagesToSend,exports.gotMessages=gotMessages;var TieredState=function(){function e(e){this.tier=e}return e}();exports.TieredState=TieredState;
//# sourceMappingURL=modeliv.min.js.map
